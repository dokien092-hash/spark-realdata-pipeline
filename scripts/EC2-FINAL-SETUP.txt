# ============================================================
# CÃC Lá»†NH HOÃ€N Táº¤T SETUP TRÃŠN EC2
# Copy tá»«ng nhÃ³m lá»‡nh vÃ  paste vÃ o EC2 terminal
# ============================================================

# NHÃ“M 1: VÃ o project vÃ  dá»«ng Grafana
cd ~/spark-realdata-pipeline
docker-compose stop grafana 2>/dev/null || true
docker-compose rm -f grafana 2>/dev/null || true

# NHÃ“M 2: Khá»Ÿi Ä‘á»™ng láº¡i containers (khÃ´ng cÃ³ Grafana)
docker-compose down
docker-compose up -d

# NHÃ“M 3: Äá»£i containers start vÃ  kiá»ƒm tra
sleep 30
docker-compose ps

# NHÃ“M 4: Táº¡o .env file (náº¿u chÆ°a cÃ³)
if [ ! -f .env ]; then
    cat > .env << 'EOF'
POLYGON_API_KEY=MKtaIeJgaIVQCxwr_HskC4NhLndLPZXR
ALPHA_VANTAGE_KEY=VWR51RQTVFTSBEL7
FINNHUB_API_KEY=d412e99r01qr2l0c96sgd412e99r01qr2l0c96t0
EOF
    echo "âœ… ÄÃ£ táº¡o .env file"
else
    echo "âœ… .env Ä‘Ã£ tá»“n táº¡i"
fi

# NHÃ“M 5: Init Airflow database
docker exec airflow-scheduler airflow db init 2>/dev/null || echo "Database Ä‘Ã£ init"

# NHÃ“M 6: Setup auto-start service (tá»± khá»Ÿi Ä‘á»™ng khi EC2 reboot)
sudo tee /etc/systemd/system/docker-compose.service > /dev/null << 'EOF'
[Unit]
Description=Docker Compose Application Service
Requires=docker.service
After=docker.service

[Service]
Type=oneshot
RemainAfterExit=yes
WorkingDirectory=/home/ec2-user/spark-realdata-pipeline
ExecStart=/usr/local/bin/docker-compose up -d
ExecStop=/usr/local/bin/docker-compose down
User=ec2-user
Group=docker

[Install]
WantedBy=multi-user.target
EOF

sudo systemctl daemon-reload
sudo systemctl enable docker-compose.service

# NHÃ“M 7: Kiá»ƒm tra auto-start Ä‘Ã£ enable
sudo systemctl is-enabled docker-compose.service
# Pháº£i hiá»ƒn thá»‹: "enabled"

# NHÃ“M 8: Äá»£i Airflow load DAGs
sleep 60

# NHÃ“M 9: Kiá»ƒm tra vÃ  unpause DAG
docker-compose exec airflow-webserver airflow dags list | grep financial
docker-compose exec airflow-webserver airflow dags unpause financial_pipeline_dag

# NHÃ“M 10: Kiá»ƒm tra káº¿t quáº£ cuá»‘i cÃ¹ng
echo ""
echo "âœ… HOÃ€N Táº¤T SETUP!"
echo ""
docker-compose ps
echo ""
echo "ðŸŒ Airflow UI: http://3.25.91.76:8081"
echo "   Username: admin | Password: admin"
echo ""
echo "â° DAG sáº½ tá»± Ä‘á»™ng cháº¡y lÃºc 7:00 sÃ¡ng VN (0:00 UTC) tá»« T2-T6"
echo ""

